name: Build and Deploy Docker Compose  

on:  
  push:  
    branches:  
      - develop 
      
jobs:  
  build:  
    runs-on: self-hosted 
    steps:  
      - name: Checkout code  
        uses: actions/checkout@v2  


      - name: Notify Telegram (Start)
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_THREAD_ID }}" \
          -d "text=üöÄ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–µ–ø–ª–æ–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è! –ë–µ–∫–µ–Ω–¥ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –û–∂–∏–¥–∞–π—Ç–µ...%0A%0A–ü–æ–∫–∞ –º–æ–∂–µ—Ç–µ –ø–æ—á–∏—Ç–∞—Ç—å:%0A%0A1) –ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –Ω–µ –≤ —Ç–æ–º, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –±–µ–∑ –æ—à–∏–±–æ–∫, –∞ –≤ —Ç–æ–º, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –ø—Ä–∏ –ª—é–±–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—à–∏–±–æ–∫.%0A%0A2) –î–µ–≤—É—à–∫–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –∏ —É—Ö–æ–¥—è—Ç, –∞ –≤–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä –∫–∞–∫ —Å—Ç–æ—è–ª, —Ç–∞–∫ –∏ –±—É–¥–µ—Ç —Å—Ç–æ—è—Ç—å.%0A%0A3) ‚Äì –õ—é–±–∏–º–∞—è, —Ç—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –Ω–∞—à –∫–æ–º–ø—å—é—Ç–µ—Ä?%0A‚Äì –î–∞.%0A‚Äì –ò –∫–∞–∫–æ–π –∂–µ –ø–∞—Ä–æ–ª—å?%0A‚Äì –î–∞—Ç–∞ –Ω–∞—à–µ–π —Å–≤–∞–¥—å–±—ã.%0A‚Äì –í–æ—Ç –±–ª–∏–Ω‚Ä¶%0A%0A4) –ï—Å–ª–∏ –≤ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞–∂–∞—Ç—å –≥–∞–∑ –∏ —Ç–æ—Ä–º–æ–∑, —Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç.%0A%0A5) –ö–æ–Ω–µ—Ü!" \
          -d "parse_mode=Markdown"

        
      - name: Docker Hub login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and Start Services 
        run: |
          docker-compose down
          docker system prune -af
          docker-compose up -d --build
          
        env:
          MINIO_ENDPOINT: ${{ vars.MINIO_ENDPOINT }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
      
      - name: Notify Telegram (Success)
        if: success()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_THREAD_ID }}" \
          -d "text=‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è! (${{ github.repository }})" \
          -d "parse_mode=Markdown"

      - name: Notify Telegram (Failure)
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_THREAD_ID }}" \
          -d "text=‚ùå –î–µ–ø–ª–æ–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É–ø–∞–ª! (${{ github.repository }})" \
          -d "parse_mode=Markdown"
